version: 2.0

jobs:
  test:
    working_directory: /tmp/project
    docker:
      - image: circleci/python:3.6.1
    steps:
      - checkout
      - run:
          name: install dig
          command: sudo apt-get update && sudo apt-get install dnsutils
      - run:
          name: Keyscan Github (HACK)
          command: ssh-keyscan $(dig +short github.com | tail -1) >> ~/.ssh/known_hosts
      - run:
          name: install dependencies
          command: |
            pip install --user -r requirements.txt
            pip install --user -r requirements-dev.txt
      - run:
          name: test
          command: ~/.local/bin/pytest
  deploy-canary:
    working_directory: /tmp/project
    docker:
      - image: circleci/python:3.6.1
    steps:
      - checkout
      - run:
          name: install dependencies
          command: |
            pip install --user -r requirements.txt
            pip install --user boto3
      - deploy:
          name: Deploy to AWS
          command: python scripts/deploy.py
  deploy-prod:
    working_directory: /tmp/project
    docker:
      - image: circleci/python:3.6.1
    steps:
      - checkout
      - run:
          name: install dependencies
          command: |
            pip install --user -r requirements.txt
            pip install --user boto3
      - deploy:
          name: Deploy to AWS
          command: |
            python scripts/deploy.py
            python scripts/publish.py

workflows:
  version: 2
  test:
    jobs:
      - test:
          filters:
            branches:
              ignore:
                - master
  deploy-canary:
    jobs:
      - test:
          filters:
            branches:
              only: master
            tags:
              ignore: /^v.*/
      - deploy-canary:
          requires:
            - test
  deploy-prod:
    jobs:
      - test:
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^v.*/
      - deploy-prod:
          filters:
            tags:
              only: /^v.*/
          requires:
            - test
